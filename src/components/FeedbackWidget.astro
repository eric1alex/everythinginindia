---
// This component receives the data it needs from the page
export interface Props {
  cityName: string;
  formUrl: string;
  cityEntry: string;
  helpfulEntry: string;
  feedbackEntry: string;
}

const { cityName, formUrl, cityEntry, helpfulEntry, feedbackEntry } = Astro.props;
---

<section id="feedback-widget" class="feedback-container">
    
    <div id="feedback-initial" class="feedback-state">
        <h3 class="feedback-title">Did you find this list useful?</h3>
        <div class="button-group">
            <button id="feedback-yes" class="feedback-button yes">✅ Yes</button>
            <button id="feedback-no" class="feedback-button no">❌ No</button>
        </div>
    </div>

    <div id="feedback-form" class="feedback-state" style="display: none;">
        <h3 class="feedback-title">What could be improved?</h3>
        <textarea id="feedback-text" class="feedback-textarea" placeholder="Your feedback is optional but appreciated!"></textarea>
        <button id="feedback-submit" class="feedback-button submit">Submit Feedback</button>
        <button id="feedback-skip" class="feedback-skip">Skip</button>
    </div>

    <div id="feedback-thanks" class="feedback-state" style="display: none;">
        <h3 class="feedback-title">Thanks for your feedback!</h3>
    </div>
</section>

<style>
    .feedback-container {
        max-width: 100%; /* Take full width */
        margin: 0rem auto 0rem auto;
        padding-top: 1rem; /* Was a full box, now just padding */
        border-top: px solid var(--card-border); /* Just a simple top line */
        text-align: center;
        
        /* --- NEW: Added for the transition --- */
        transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        opacity: 1;
        transform: translateY(0);
    }

    /* --- NEW: This class will trigger the fade-out --- */
    .feedback-container.hiding {
        opacity: 0;
        transform: translateY(20px);
    }

    .feedback-state {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .feedback-title {
        font-size: 1.25rem; /* Was 1.5rem */
        font-weight: 600;
        margin-bottom: 1.5rem;
    }
    .button-group {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }
    .feedback-button {
        font-size: 0.9rem; /* Was 1rem */
        font-weight: 600;
        padding: 0.5rem 1rem; /* Was 0.75rem 1.5rem */
        border-radius: 6px; /* Was 8px */
        border: 1px solid #ccc;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: #fff;
    }
    .feedback-button.yes:hover {
        background-color: #e6f7ec;
        border-color: #a3d9b1;
    }
    .feedback-button.no:hover {
        background-color: #fdebee;
        border-color: #f7b5b5;
    }
    .feedback-button.submit {
        background-color: #1a1a1a;
        color: #fff;
        border-color: #1a1a1a;
        width: 100%;
        max-width: 300px; /* Stop it from being full-width */
    }
    .feedback-button.submit:hover {
        background-color: #333;
    }
    .feedback-textarea {
        width: 100%;
        max-width: 500px; /* Constrain width */
        min-height: 100px;
        padding: 0.75rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-family: 'Inter', sans-serif;
        font-size: 1rem;
        margin-bottom: 1rem;
    }
    .feedback-skip {
        background: none;
        border: none;
        color: #888;
        font-size: 0.9rem;
        cursor: pointer;
        margin-top: 1rem;
    }
</style>

<script is:inline define:vars={{ cityName, formUrl, cityEntry, helpfulEntry, feedbackEntry }}>
    document.addEventListener('DOMContentLoaded', () => {
        const widget = document.getElementById('feedback-widget');
        const initialState = document.getElementById('feedback-initial');
        const formState = document.getElementById('feedback-form');
        const thanksState = document.getElementById('feedback-thanks');

        const btnYes = document.getElementById('feedback-yes');
        const btnNo = document.getElementById('feedback-no');
        const btnSubmit = document.getElementById('feedback-submit');
        const btnSkip = document.getElementById('feedback-skip');
        const feedbackText = document.getElementById('feedback-text');
        
        const storageKey = `feedback-submitted-${cityName}`;

        if (localStorage.getItem(storageKey)) {
            widget.style.display = 'none';
            return;
        }

        btnYes.addEventListener('click', () => {
            submitToGoogle('Yes', '');
            showThanks();
        });

        btnNo.addEventListener('click', () => {
            initialState.style.display = 'none';
            formState.style.display = 'block';
        });

        btnSubmit.addEventListener('click', () => {
            submitToGoogle('No', feedbackText.value);
            showThanks();
        });

        btnSkip.addEventListener('click', () => {
            submitToGoogle('No', 'SKIPPED');
            showThanks();
        });

        function showThanks() {
            initialState.style.display = 'none';
            formState.style.display = 'none';
            thanksState.style.display = 'block';
            localStorage.setItem(storageKey, 'true');

            // --- THIS IS THE UPDATED CODE ---
            // After 5 seconds, add the 'hiding' class to trigger the transition
            setTimeout(() => {
                widget.classList.add('hiding');
                
                // After the transition finishes (500ms), 
                // set display: none to remove it completely
                setTimeout(() => {
                    widget.style.display = 'none';
                }, 500); // This must match the transition duration in the CSS
                
            }, 1000); // 5000 milliseconds = 5 seconds
            // -----------------------------
        }

        async function submitToGoogle(isHelpful, feedback) {
            const formData = new FormData();
            formData.append(cityEntry, cityName);
            formData.append(helpfulEntry, isHelpful);
            formData.append(feedbackEntry, feedback);

            try {
                await fetch(formUrl, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors'
                });
            } catch (e) {
                console.error('Error submitting feedback:', e);
            }
        }
    });
</script>