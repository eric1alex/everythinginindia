---
import locations from "~/data/locations.json";

export interface Props {
    formUrl: string;
    cityEntryID: string;
    emailEntryID: string;
}

const { formUrl, cityEntryID, emailEntryID } = Astro.props;

// Build list of all cities for checking
const allCities = [...locations.states, ...locations.unionTerritories].flatMap(
    (loc) =>
        loc.cities.map((city) => ({
            name: city.name.toLowerCase(),
            displayName: city.name,
            slug: city.slug,
            stateSlug: loc.slug,
            stateName: loc.name,
        })),
);
---

<section id="city-request-widget" class="request-container">
    <div id="request-step1">
        <h3 class="request-title">Which city should we cover next?</h3>
        <p class="request-text">
            We build guides based on what you want. Tell us where to go!
        </p>

        <div class="input-wrapper">
            <input
                type="text"
                id="city-input"
                class="request-input"
                placeholder="e.g. Jaipur, Shillong, Hampi..."
            />
            <button id="city-next-btn" class="request-btn">Next</button>
        </div>

        <!-- City Already Exists Message (inline) -->
        <div id="city-exists-msg" class="exists-message" style="display: none;">
            <p>
                ðŸŽ‰ Great news! <strong id="found-city-name"></strong> is already in
                our directory.
            </p>
            <a id="city-link" href="#" class="city-link">View the guide â†’</a>
        </div>
    </div>

    <div id="request-step2" style="display: none;">
        <h3 class="request-title">Almost done! âœ¨</h3>
        <p class="request-text city-display"></p>

        <div class="email-section">
            <p class="email-helper">
                If you'd like to be notified when this city goes live, please
                share your email (optional)
            </p>
            <div class="input-wrapper">
                <input
                    type="email"
                    id="email-input"
                    class="request-input"
                    placeholder="your@email.com (optional)"
                />
                <button id="request-submit" class="request-btn">Submit</button>
            </div>
            <button id="skip-email" class="skip-btn">Skip</button>
        </div>
    </div>

    <div id="request-thanks" style="display: none;">
        <h3 class="request-title">Thanks! ðŸš€</h3>
        <p class="request-text">We've added that to our list.</p>
    </div>
</section>

<style>
    .request-container {
        max-width: 600px;
        margin: 4rem auto 2rem auto;
        padding: 2.5rem 2rem;
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
        transition: all 0.3s ease;
    }

    .request-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }

    .request-text {
        font-size: 0.95rem;
        color: #64748b;
        margin-bottom: 1.5rem;
    }

    .city-display {
        font-weight: 600;
        color: #1e293b;
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }

    .email-section {
        margin-top: 1.5rem;
    }

    .email-helper {
        font-size: 0.85rem;
        color: #64748b;
        margin-bottom: 1rem;
        line-height: 1.5;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    .input-wrapper {
        display: flex;
        gap: 0.5rem;
        max-width: 400px;
        margin: 0 auto;
    }

    .request-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 0.95rem;
        outline: none;
        transition: all 0.2s;
    }

    .request-input:focus {
        border-color: #1e293b;
        box-shadow: 0 0 0 3px rgba(30, 41, 59, 0.1);
    }

    .request-btn {
        padding: 0.75rem 1.5rem;
        background-color: #1e293b;
        color: white;
        font-weight: 600;
        font-size: 0.95rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .request-btn:hover {
        background-color: #0f172a;
    }

    .exists-message {
        margin-top: 1.5rem;
        padding: 1rem 1.25rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #475569;
        line-height: 1.5;
    }

    .exists-message p {
        margin: 0;
    }

    .city-link {
        display: inline-block;
        margin-top: 0.5rem;
        color: #1e293b;
        font-weight: 500;
        text-decoration: underline;
    }

    .city-link:hover {
        color: #0f172a;
    }

    .skip-btn {
        margin-top: 0.75rem;
        padding: 0.5rem 1rem;
        background: none;
        border: none;
        color: #64748b;
        font-size: 0.85rem;
        cursor: pointer;
        text-decoration: underline;
        transition: color 0.2s;
    }

    .skip-btn:hover {
        color: #1e293b;
    }

    @media (max-width: 480px) {
        .input-wrapper {
            flex-direction: column;
        }
        .request-btn {
            width: 100%;
        }
    }
</style>

<script
    is:inline
    define:vars={{ formUrl, cityEntryID, emailEntryID, allCities }}
>
    document.addEventListener("DOMContentLoaded", () => {
        const step1 = document.getElementById("request-step1");
        const step2 = document.getElementById("request-step2");
        const thanksView = document.getElementById("request-thanks");
        const existsMsg = document.getElementById("city-exists-msg");

        const cityInput = document.getElementById("city-input");
        const cityNextBtn = document.getElementById("city-next-btn");
        const emailInput = document.getElementById("email-input");
        const submitBtn = document.getElementById("request-submit");
        const skipBtn = document.getElementById("skip-email");
        const cityLink = document.getElementById("city-link");
        const foundCityName = document.getElementById("found-city-name");
        const cityDisplay = document.querySelector(".city-display");

        let cityValue = "";

        // Hide exists message when user types again
        cityInput.addEventListener("input", () => {
            existsMsg.style.display = "none";
        });

        // Step 1: Check if city exists when clicking Next
        cityNextBtn.addEventListener("click", () => {
            cityValue = cityInput.value.trim();
            if (!cityValue) return;

            // Check if city exists in our list
            const match = allCities.find(
                (city) => city.name === cityValue.toLowerCase(),
            );

            if (match) {
                // City exists - show message, block submission
                foundCityName.textContent = match.displayName;
                cityLink.href = `/${match.stateSlug}/${match.slug}`;
                existsMsg.style.display = "block";
            } else {
                // City doesn't exist - proceed with request
                cityDisplay.textContent = `You requested: ${cityValue}`;
                step1.style.display = "none";
                step2.style.display = "block";
            }
        });

        // Allow Enter key on city input
        cityInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                cityNextBtn.click();
            }
        });

        // Step 2: Submit with email
        submitBtn.addEventListener("click", () => {
            const emailValue = emailInput.value.trim();
            submitToGoogle(cityValue, emailValue);
            showThanks();
        });

        // Step 2: Skip email
        skipBtn.addEventListener("click", () => {
            submitToGoogle(cityValue, "");
            showThanks();
        });

        // Allow Enter key on email input
        emailInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                submitBtn.click();
            }
        });

        function showThanks() {
            step2.style.display = "none";
            thanksView.style.display = "block";
            localStorage.setItem("city-request-submitted", "true");
        }

        async function submitToGoogle(city, email) {
            const formData = new FormData();
            formData.append(cityEntryID, city);
            if (email) {
                formData.append(emailEntryID, email);
            }

            try {
                await fetch(formUrl, {
                    method: "POST",
                    body: formData,
                    mode: "no-cors",
                });
            } catch (e) {
                console.error(e);
            }
        }
    });
</script>
