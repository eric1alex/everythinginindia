---
export interface Props {
  dashboard: {
    bestTime: string;
    bestTimeDescription?: string;
    idealDuration: string;
    budget: string | { min: string; max: string; currency: string };
    transport: string;
    howToReach: {
        air: string;
        train: string;
        road: string;
    };
  };
  mapUrl: string;
}

const { dashboard, mapUrl } = Astro.props;

// Helper to check if budget is an object
const isBudgetObject = (budget: any): budget is { min: string; max: string; currency: string } => {
    return typeof budget === 'object' && budget !== null && 'min' in budget;
};

// SVG Icons (Smaller size: 18px)
const icons = {
    calendar: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
    wallet: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"></path><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h2v-4Z"></path></svg>',
    map: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>',
    plane: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"></path><path d="M22 2l-7 20-4-9-9-4 20-7z"></path></svg>',
    clock: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
    car: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>'
};
---

{dashboard && (
    <div class="city-dashboard">
        <div class="dashboard-grid">
            
            <!-- 1. Best Time -->
            <div class="fact-card">
                <div class="card-header">
                    <div class="icon" set:html={icons.calendar}></div>
                    <span class="label">Best Time to Visit</span>
                </div>
                <div class="content">
                    <h3 class="value-lg">{dashboard.bestTime}</h3>
                    {dashboard.bestTimeDescription && (
                        <p class="description">{dashboard.bestTimeDescription}</p>
                    )}
                </div>
            </div>

            <!-- 2. Ideal Duration -->
            <div class="fact-card">
                <div class="card-header">
                    <div class="icon" set:html={icons.clock}></div>
                    <span class="label">Ideal Duration</span>
                </div>
                <div class="content">
                    <h3 class="value-lg">{dashboard.idealDuration}</h3>
                    <p class="description-sm">Perfect for a relaxed trip.</p>
                </div>
            </div>

            <!-- 3. Budget -->
            <div class="fact-card">
                <div class="card-header">
                    <div class="icon" set:html={icons.wallet}></div>
                    <span class="label">Daily Budget (Solo)</span>
                </div>
                <div class="content">
                    {isBudgetObject(dashboard.budget) ? (
                        <>
                            <h3 class="value-lg">{dashboard.budget.min} - {dashboard.budget.max} <span class="currency">{dashboard.budget.currency}</span></h3>
                            
                            <div class="budget-visual">
                                <div class="budget-row">
                                    <span class="budget-tag">Min</span>
                                    <div class="bar-bg"><div class="bar-fill" style="width: 40%"></div></div>
                                </div>
                                <div class="budget-row">
                                    <span class="budget-tag">Max</span>
                                    <div class="bar-bg"><div class="bar-fill" style="width: 80%"></div></div>
                                </div>
                            </div>
                        </>
                    ) : (
                        <h3 class="value-lg">{dashboard.budget}</h3>
                    )}
                </div>
            </div>

            <!-- 4. Transport (Local) -->
            <div class="fact-card">
                <div class="card-header">
                    <div class="icon" set:html={icons.car}></div>
                    <span class="label">Local Transport</span>
                </div>
                <div class="content">
                    <h3 class="value-lg">{dashboard.transport}</h3>
                    <p class="description-sm">Best way to get around.</p>
                </div>
            </div>

            <!-- 5. Getting There -->
            <div class="fact-card">
                <div class="card-header">
                    <div class="icon" set:html={icons.plane}></div>
                    <span class="label">Getting There</span>
                </div>
                <div class="content reach-content">
                    {dashboard.howToReach && (
                        <div class="reach-list">
                            <div class="reach-item">
                                <span class="reach-label">Nearest Airport</span>
                                <span class="reach-text">{dashboard.howToReach.air}</span>
                            </div>
                            <div class="reach-item">
                                <span class="reach-label">Nearest Train</span>
                                <span class="reach-text">{dashboard.howToReach.train}</span>
                            </div>
                        </div>
                    )}
                </div>
            </div>

            <!-- 6. Location -->
            <div class="fact-card location-card">
                <div class="location-bg-icon" set:html={icons.map}></div>
                <div class="location-info">
                    <span class="coords-text">15.4800, 73.8200</span>
                    <span class="location-label">Location</span>
                </div>
                <a href={mapUrl} target="_blank" rel="noopener noreferrer" class="map-btn">
                    Open Maps â†—
                </a>
            </div>
        </div>
    </div>
)}

<style>
    .city-dashboard {
        background: white;
        border-radius: 12px;
        border: 1px solid var(--card-border);
        padding: 1rem; /* Reduced padding for mobile */
        margin-top: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-sm);
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* 2 Columns on Mobile for compactness */
        gap: 0.75rem; /* Smaller gap on mobile */
    }

    .fact-card {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.75rem;
        border-radius: 8px;
        background: #f8fafc;
        border: 1px solid #f1f5f9;
        min-height: 120px; /* Reduced min-height for mobile */
        justify-content: flex-start;
        overflow: hidden; /* Prevent overflow */
    }

    .card-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.25rem;
    }

    .icon {
        color: var(--link-color);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .label {
        font-size: 0.7rem; /* Slightly smaller on mobile */
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .content {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        flex: 1;
        min-width: 0; /* Allow text truncation */
    }

    .value-lg {
        font-size: 1rem; /* Smaller on mobile */
        font-weight: 700;
        color: #0f172a;
        margin: 0;
        line-height: 1.3;
        word-break: break-word; /* Prevent long words breaking layout */
    }

    .currency {
        font-size: 0.85rem;
        font-weight: 600;
        color: #64748b;
    }

    .description {
        font-size: 0.75rem;
        color: #475569;
        line-height: 1.4;
        margin: 0;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .description-sm {
        font-size: 0.7rem;
        color: #94a3b8;
        font-style: italic;
        margin: 0;
    }

    /* Budget Visuals */
    .budget-visual {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        padding-top: 0.5rem;
    }

    .budget-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .budget-tag {
        font-size: 0.65rem;
        color: #64748b;
        width: 20px;
    }

    .bar-bg {
        flex: 1;
        height: 5px;
        background: #e2e8f0;
        border-radius: 3px;
        overflow: hidden;
    }

    .bar-fill {
        height: 100%;
        background: var(--link-color);
        border-radius: 3px;
    }

    /* Reach List */
    .reach-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .reach-item {
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
        min-width: 0;
    }

    .reach-label {
        font-size: 0.65rem;
        text-transform: uppercase;
        color: #94a3b8;
        font-weight: 700;
    }

    .reach-text {
        font-size: 0.8rem;
        color: #334155;
        font-weight: 500;
        line-height: 1.3;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Location Card */
    .location-card {
        background: linear-gradient(135deg, #475569 0%, #1e293b 100%);
        color: white;
        position: relative;
        overflow: hidden;
        justify-content: flex-end;
        border: none;
        grid-column: span 2; /* Make location card full width on mobile if needed, or keep 1 col */
    }
    
    /* Make location card span full width on mobile for better map button access? 
       Actually, let's keep it 1 col to fit the 2-col grid, but ensure it handles small width. */
    @media (max-width: 400px) {
        .dashboard-grid {
            grid-template-columns: 1fr; /* Fallback to 1 col for very small screens */
        }
        .location-card {
            grid-column: auto;
        }
    }

    .location-bg-icon {
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0.1;
        color: white;
    }
    
    .location-bg-icon :global(svg) {
        width: 50px;
        height: 50px;
    }

    .location-info {
        position: relative;
        z-index: 1;
        margin-bottom: auto; 
    }

    .coords-text {
        font-family: monospace;
        font-size: 0.65rem;
        opacity: 0.7;
        display: block;
        margin-bottom: 0.1rem;
    }

    .location-label {
        font-size: 0.9rem;
        font-weight: 600;
        display: block;
    }

    .map-btn {
        position: relative;
        z-index: 1;
        background: white;
        color: #0f172a;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-decoration: none;
        align-self: flex-end;
        transition: background 0.2s;
    }

    .map-btn:hover {
        background: #f8fafc;
    }

    @media (min-width: 768px) {
        .dashboard-grid {
            grid-template-columns: repeat(3, 1fr); /* 3 Columns on Desktop */
            gap: 1.25rem;
        }
        
        .city-dashboard {
            padding: 1.5rem;
        }

        .location-card {
            grid-column: span 1; /* Force 1 column on desktop */
        }
        
        .value-lg {
            font-size: 1.1rem;
        }
        .label {
            font-size: 0.75rem;
        }
    }
</style>