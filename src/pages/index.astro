---
import Layout from '~/layouts/Layout.astro';
import locations from '~/data/locations.json';

// --- NEW LOGIC FOR "FEELING LUCKY" ---
// 1. Find all the .json files that actually exist.
// We use '../../' because this file is in src/pages/
const allCityDataFiles = await import.meta.glob('../data/cities/*.json'); 
const existingSlugs = Object.keys(allCityDataFiles).map(path => 
  path.split('/').pop().replace('.json', '')
);

// 2. Create the list of available FULL PATHS for lucky redirection
const availablePaths = [];
[...locations.states, ...locations.unionTerritories].forEach(loc => {
  loc.cities.forEach(city => {
    // Only add the path if the city's data file exists
    if (existingSlugs.includes(city.slug)) {
      // Push the full path: /karnataka/bengaluru
      availablePaths.push(`/${loc.slug}/${city.slug}`);
    }
  });
});
// --- END OF NEW LOGIC ---

const states = locations.states;
const unionTerritories = locations.unionTerritories;
---

<Layout 
  title="Where In India - The most trusted list of recos for India"
  description="A hand-curated travel directory for India, built for easy exploration and trip planning. Stop getting lost on Google."
  ogImage="https://placehold.co/1200x630/333/fff?text=Where+In+India"
>
	<main>
		<!-- New Hero Section -->
		<header class="hero">
			<div class="hero-image"></div>
			<div class="hero-text">
				<h1>The most trusted list of recos for India</h1>
				<p>Stop getting lost on Google.</p>
				<div class="socials">
					<a href="#" title="WhatsApp" aria-label="WhatsApp">
						<svg fill="currentColor" viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.61 15.36 3.48 16.84L2.05 22L7.31 20.58C8.75 21.39 10.36 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 6.45 17.5 2 12.04 2M12.04 20.13C10.5 20.13 9.01 19.67 7.7 18.84L7.29 18.57L4.35 19.4L5.25 16.54L4.96 16.12C4.06 14.7 3.57 13.09 3.57 11.91C3.57 7.31 7.38 3.5 12.04 3.5C16.7 3.5 20.5 7.31 20.5 11.91C20.5 16.51 16.7 20.13 12.04 20.13M17.44 14.63C17.2 14.51 16.03 13.92 15.82 13.84C15.61 13.76 15.46 13.72 15.31 13.96C15.16 14.2 14.68 14.78 14.53 14.94C14.38 15.09 14.23 15.11 13.99 14.99C13.75 14.87 12.89 14.57 11.89 13.67C11.11 12.98 10.59 12.11 10.44 11.87C10.29 11.63 10.42 11.49 10.56 11.35C10.69 11.23 10.83 11.03 10.98 10.85C11.13 10.67 11.18 10.55 11.28 10.35C11.38 10.15 11.33 9.98 11.25 9.83C11.17 9.68 10.72 8.5 10.52 8.01C10.33 7.52 10.13 7.59 9.98 7.58C9.83 7.58 9.68 7.58 9.53 7.58C9.38 7.58 9.11 7.66 8.89 7.89C8.67 8.13 8.09 8.68 8.09 9.83C8.09 10.98 8.92 12.08 9.07 12.23C9.22 12.38 10.72 14.82 13.16 15.87C13.74 16.13 14.19 16.3 14.55 16.43C15.16 16.64 15.65 16.6 15.92 16.33C16.23 16.03 17.02 15.2 17.2 14.94C17.38 14.68 17.68 14.76 17.44 14.63Z" /></svg>
					</a>
					<a href="#" title="Twitter / X" aria-label="Twitter / X">
						<svg fill="currentColor" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z" /></svg>
					</a>
					<a href="#" title="X" aria-label="X">
						<svg fill="currentColor" viewBox="0 0 24 24"><path d="M 4.4042969 3 C 3.7582969 3 3.3212969 3.633 3.5234375 4.2285156 L 6.6660156 12 L 3.5234375 19.771484 C 3.3212969 20.367484 3.7582969 21 4.4042969 21 L 9.2714844 21 L 12.810547 15.013672 L 16.349609 21 L 20.216797 21 C 20.862797 21 21.299797 20.367484 21.097656 19.771484 L 17.955078 12 L 21.097656 4.2285156 C 21.299797 3.6325156 20.862797 3 20.216797 3 L 15.349609 3 L 11.810547 8.9863281 L 8.2714844 3 L 4.4042969 3 z"/></svg>
					</a>
				</div>
			</div>
		</header>

		<!-- Search Bar -->
		<div class="search-container">
			<div class="search-wrapper">
				<div class="search-bar">
					<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
					</svg>
					<input type="text" id="state-search" placeholder="Search for a state or city...">
				</div>
                <button id="feeling-lucky" class="lucky-button">Feeling Lucky?</button>
            </div>
		</div>

		<!-- Simplified 2-Column List Grid -->
		<div class="main-content">
			<div class="list-grid">
				<!-- Column 1: States -->
				<div class="list-column">
					<h2><span class="emoji">ğŸ“</span> States</h2>
					<ol>
						{states.map(state => (
							<li class="list-item" data-name={state.name.toLowerCase()} data-state-slug={state.slug} data-cities={JSON.stringify(state.cities.map(c => c.name.toLowerCase()))}>
								<a 
									href="#" 
									class="state-link"
									data-state={state.name}
									data-cities={JSON.stringify(state.cities)}
								>{state.name}</a>
								<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg>
							</li>
						))}
					</ol>
				</div>
				
				<!-- Column 2: Union Territories -->
				<div class="list-column">
					<h2><span class="emoji">ğŸ‡®ğŸ‡³</span> Union Territories</h2>
					<ol>
						{unionTerritories.map(ut => (
							<li class="list-item" data-name={ut.name.toLowerCase()} data-state-slug={ut.slug} data-cities={JSON.stringify(ut.cities.map(c => c.name.toLowerCase()))}>
								<a 
									href="#" 
									class="state-link"
									data-state={ut.name}
									data-cities={JSON.stringify(ut.cities)}
								>{ut.name}</a>
								<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg>
							</li>
						))}
					</ol>
				</div>
			</div>
		</div>
	</main>

	<!-- Modal (Floating Window) HTML -->
	<div id="city-modal" class="modal-overlay">
		<div class="modal-content">
			<div class="modal-header">
				<h2 id="modal-title">Cities in [State]</h2>
				<button id="modal-close" class="modal-close" aria-label="Close modal">&times;</button>
			</div>
			<div id="modal-body">
				<p id="modal-no-cities" style="display: none;">No specific cities listed yet. The main page for this location is coming soon!</p>
				<ol id="modal-city-list"></ol>
			</div>
		</div>
	</div>

	<!-- Client-side script for Search and Modal -->
	<script is:raw define:vars={{ availablePaths }}>
		document.addEventListener('DOMContentLoaded', () => {
			// --- STATE/CITY SEARCH LOGIC ---
			const searchInput = document.getElementById('state-search');
			const listItems = document.querySelectorAll('.list-item');

			searchInput.addEventListener('input', (e) => {
				const searchTerm = e.target.value.toLowerCase().trim();

				listItems.forEach(item => {
                    const itemName = item.dataset.name;
                    const cityNames = JSON.parse(item.dataset.cities || '[]');
                    
                    const nameMatch = itemName.includes(searchTerm);
                    const cityMatch = cityNames.some(city => city.includes(searchTerm));

					if (nameMatch || cityMatch) {
						item.style.display = 'flex';
					} else {
						item.style.display = 'none';
					}
				});
			});

			// --- MODAL (FLOATING WINDOW) LOGIC ---
			const modal = document.getElementById('city-modal');
			const modalTitle = document.getElementById('modal-title');
			const modalCityList = document.getElementById('modal-city-list');
			const modalNoCities = document.getElementById('modal-no-cities');
			const modalClose = document.getElementById('modal-close');
			const stateLinks = document.querySelectorAll('.state-link');

			stateLinks.forEach(link => {
				link.addEventListener('click', (e) => {
					e.preventDefault();
					
					const stateName = link.dataset.state;
					const cities = JSON.parse(link.dataset.cities);
                    
                    // FIX: Get the state slug from the parent <li>
                    const stateSlug = link.closest('li').dataset.stateSlug;

                    // If only 1 city, go directly to /state/city
					if (cities.length === 1 && cities[0].slug) {
                        // Ensure stateSlug exists to prevent broken links
                        if (stateSlug) {
						    window.location.href = `/${stateSlug}/${cities[0].slug}`;
                        } else {
                            // Fallback (should not happen if JSON is correct)
                            window.location.href = `/${cities[0].slug}`; 
                        }
						return;
					}
					
					modalTitle.textContent = `Cities in ${stateName}`;
					modalCityList.innerHTML = '';

					if (cities.length > 0) {
						modalNoCities.style.display = 'none';
						modalCityList.style.display = 'block';

						cities.forEach(city => {
							const li = document.createElement('li');
							const a = document.createElement('a');
                            // FIX: Link now points to /state/city
							a.href = `/${stateSlug}/${city.slug}`;
							a.textContent = city.name;
							li.appendChild(a);
							modalCityList.appendChild(li);
						});
					} else {
						modalNoCities.style.display = 'block';
						modalCityList.style.display = 'none';
					}

					modal.classList.add('visible');
				});
			});

			// Function to close the modal
			const closeModal = () => {
				modal.classList.remove('visible');
			}

			// Close modal when X is clicked
			modalClose.addEventListener('click', closeModal);

			// Close modal when clicking on the overlay
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					closeModal();
				}
			});

            // --- "FEELING LUCKY?" LOGIC ---
            const luckyButton = document.getElementById('feeling-lucky');
            if (luckyButton) {
                luckyButton.addEventListener('click', () => {
                    // FIX: Use availablePaths which now contains full paths like /state/city
                    if (availablePaths && availablePaths.length > 0) {
                        const randomIndex = Math.floor(Math.random() * availablePaths.length);
                        const randomPath = availablePaths[randomIndex];
                        window.location.href = randomPath;
                    }
                });
            }
		});
	</script>
</Layout>